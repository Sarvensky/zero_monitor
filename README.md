# ZeroTier Monitor

[English version](README.en.md)

Скрипт для активного мониторинга состояния узлов (компьютеров) в одной или нескольких сетях ZeroTier. Он отслеживает онлайн-статус, актуальность версии клиента и отправляет уведомления о проблемах в Telegram.

## Основные возможности

- **Мониторинг нескольких сетей**: Поддержка нескольких сетей ZeroTier с разными токенами доступа.
- **Отслеживание статуса**: Проверяет, находится ли узел в сети, и как давно он был активен.
- **Проверка версии клиента**: Сравнивает версию клиента ZeroTier на узле с последней официальной версией на GitHub.
- **Умные уведомления**: Отправляет сообщения в Telegram только при обнаружении проблем или при восстановлении работоспособности.
- **Эскалация оповещений**: Разные уровни уведомлений в зависимости от длительности офлайна (например, через 5 минут, 15 минут, 1 час).
- **Пинг-проверка**: При обнаружении офлайна дополнительно проверяет доступность узла по IP-адресу с помощью ICMP (ping).
- **Ежедневные отчеты**: Каждый день в полночь отправляет сводный отчет о количестве проверок и выявленных инцидентах за прошедший день.
- **Локальная база данных**: Использует SQLite для хранения состояния узлов между проверками, что позволяет избежать ложных срабатываний.
- **Устойчивость к сбоям API**: Реализованы повторные попытки для сетевых запросов к API ZeroTier и Telegram.
- **Обнаружение аномалий**: Сглаживает редкие аномальные скачки в данных `lastSeen` от API ZeroTier.

## Как это работает

1.  **Инициализация**: При запуске скрипт читает конфигурацию из `.env` файла, инициализирует базу данных SQLite и отправляет уведомление о старте.
2.  **Бесконечный цикл**: Скрипт работает в бесконечном цикле с заданным интервалом (`CHECK_INTERVAL_SECONDS`).
3.  **Получение данных**: В каждом цикле он запрашивает у API ZeroTier список всех участников указанных сетей и последнюю версию клиента с GitHub.
4.  **Анализ узлов**: Для каждого отслеживаемого узла (`MEMBER_IDS`) скрипт:
    - Сравнивает его состояние с сохраненным в локальной базе данных.
    - Проверяет время последней активности (`lastSeen`). Если узел долго неактивен, генерируется отчет.
    - Проверяет версию клиента. Если версия устарела, генерируется отчет.
    - Если сгенерирован отчет об офлайне, дополнительно выполняется пинг-проверка.
5.  **Отправка отчетов**: Если были сгенерированы отчеты о проблемах, они объединяются в одно сообщение и отправляются в Telegram.
6.  **Сохранение состояния**: Новое состояние каждого узла (статус онлайн, отправленные уведомления) сохраняется в базу данных.
7.  **Ежедневная сводка**: Раз в сутки скрипт отправляет итоговый отчет за прошедший день и сбрасывает суточные счетчики.

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone https://github.com/sarvensky/zero_monitor.git
cd zero_monitor
```

### 2. Установка зависимостей

Убедитесь, что у вас установлен Python 3.6+ и pip.

```bash
pip install -r requirements.txt
```

### 3. Настройка конфигурации

Создайте файл `.env` в корневой папке проекта, скопировав содержимое из `.env.example`, и заполните его вашими данными.

```bash
cp .env.example .env
```

Откройте файл `.env` в текстовом редакторе и укажите значения для следующих переменных:

- `ZEROTIER_NETWORKS_JSON`: JSON-строка с данными ваших сетей.
- `MEMBER_IDS_CSV`: ID узлов для мониторинга, перечисленные через запятую.
- `TELEGRAM_BOT_TOKEN`: Токен вашего Telegram-бота.
- `TELEGRAM_CHAT_ID`: ID чата или канала в Telegram для отправки уведомлений.
- `CHECK_INTERVAL_SECONDS` (опционально): Интервал проверок в секундах (по умолчанию 300).

## Запуск

Для запуска мониторинга используйте `START.bat` (для Windows) или `start.sh` (для Linux), либо выполните команду напрямую:

```bash
python main.py
```

Скрипт начнет работу в консоли, будет выводить логи и отправлять уведомления в Telegram при необходимости.

## Детальное описание конфигурации (`.env`)

- **`ZEROTIER_NETWORKS_JSON`**:
  - **Формат**: JSON-массив (список) объектов.
  - **Каждый объект должен содержать**:
    - `token`: API-токен для доступа к сети ZeroTier.
    - `network_id`: ID вашей сети ZeroTier.
  - **Пример для одной сети**:
    ```json
    [{"token": "YOUR_ZEROTIER_API_TOKEN", "network_id": "YOUR_NETWORK_ID"}]
    ```
  - **Пример для двух сетей**:
    ```json
    [
      {"token": "TOKEN_1", "network_id": "NETWORK_ID_1"},
      {"token": "TOKEN_2", "network_id": "NETWORK_ID_2"}
    ]
    ```

- **`MEMBER_IDS_CSV`**:
  - **Формат**: Строка, содержащая 10-значные ID узлов ZeroTier, разделенные запятыми.
  - **Пример**:
    ```
    1234567890,0987654321,abcdef1234
    ```

- **`TELEGRAM_BOT_TOKEN`**:
  - Токен, полученный от [@BotFather](https://t.me/BotFather) при создании бота.

- **`TELEGRAM_CHAT_ID`**:
  - Уникальный идентификатор чата, куда бот будет отправлять сообщения. Чтобы его узнать, можно воспользоваться ботом [@userinfobot](https://t.me/userinfobot).

- **`CHECK_INTERVAL_SECONDS`**:
  - **Формат**: Целое число.
  - **Описание**: Как часто (в секундах) скрипт будет выполнять проверку.
  - **По умолчанию**: `300` (5 минут).
